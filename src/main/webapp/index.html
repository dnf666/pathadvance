<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="chrome=1">
	<link rel="stylesheet" type="text/css" href="./style/init.css">
	<link rel="stylesheet" type="text/css" href="./style/index.css">
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=c0yGtp0Plt9NjWKiLZorq0Ckc29hrgFn"></script>
	<script type="text/javascript" src="./js/lib/jquery-3.3.1.min.js"></script>
	<script type="text/javascript" src="./js/index.js"></script>
	<style type="text/css">
    	html,body{height:100%; width:100%; overflow:hidden; margin:0; padding:0;}
    </style>
	<title>path optimization</title>
</head>
<body>
	<!-- 创建全屏地图 -->
	<div id="container" style="width: 100%;height: 100%;overflow: hidden;background-color: #ccc"></div>
	<div class="logo">
		<div class="logo-img"><img src="./images/logo.png" width="100%" height="100%"></div>
		<!-- logo部分 -->
		<div class="logo-text"><p>基于百度地图的电子商务配送路径优化系统</p><p>EC distribution path optimization system</p></div>
	</div>
	<!-- 进度部分 -->
	<ul class="progress">
		<li class="pro pro1">
			<div class="pro-right pro-right1"><span>基本信息录入</span></div>
			<div class="pro-left pro-left1"><span>P:20%</span></div>
		</li>
		<li class="pro pro2">
			<div class="pro-right pro-right2"><span>计算两点时间距离</span></div>
			<div class="pro-left pro-left2"><span>P:20%</span></div>
		</li>
		<li class="pro pro3">
			<div class="pro-right pro-right3"><span>执行算法</span></div>
			<div class="pro-left pro-left3"><span>P:20%</span></div>
		</li>
		<li class="pro pro4">
			<div class="pro-right pro-right4"><span>绘制地图</span></div>
			<div class="pro-left pro-left4"><span>P:20%</span></div>
		</li>
	</ul>
	<!-- 右侧弹框部分 -->
	<div class="info">
		<h1 class="info-tit">基本信息录入</h1>
		<ul class="info-panel">
			<li class="info-panel-wrap">
				<h2 class="info-panel-tit">中心点信息导入</h2>
				<div class="info-panel-cont">
					<div class="info-file"><a href="./data/center.csv" download="center.csv">下载模板文件：center.csv</a>
						<form action="/path/csv/importCenterNode.do" method="post" enctype="multipart/form-data">
							<input type="file" name="info-fileselect" class="info-fileselect" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />
							<input type="submit" name="info-fileadd" class="info-fileadd" value="上传" />
						</form>
					</div>
					<div class="info-search">
						<input type="text" name="file-search-text" placeholder="查询所需地址是否添加" class="file-search-text"><input type="submit" name="file-search-action" value="" class="file-search-action">
						<p class="file-search-result"><span>该地址未添加</span><a href="#"></a></p>
					</div>
				</div>
			</li>
			<li class="info-panel-wrap">
				<h2 class="info-panel-tit">服务点信息导入</h2>
				<div class="info-panel-cont">
					<div class="info-file"><a href="./data/service.csv" download="service.csv">下载模板文件：service.csv</a>
						<form action="/path/csv/importServiceNode.do" method="post" enctype="multipart/form-data">
							<input type="file" name="info-fileselect" class="info-fileselect" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />
							<input type="submit" name="info-fileadd" class="info-fileadd" value="上传" />
						</form>
					</div>
					<div class="info-search">
						<input type="text" name="file-search-text" placeholder="查询所需地址是否添加" class="file-search-text"><input type="submit" name="file-search-action" value="" class="file-search-action">
						<p class="file-search-result"><span>该地址未添加</span><a href="#"></a></p>
					</div>
				</div>
			</li>
			<li class="info-panel-wrap">
				<h2 class="info-panel-tit">车辆信息导入</h2>
				<div class="info-panel-cont">
					<!--发送文件-->
					<div class="info-file"><a href="./data/car.csv" download="car.csv">下载模板文件：car.csv</a>
						<form action="/path/csv/importVahicle.do"method="post" enctype="multipart/form-data"><input type="file" name="info-fileselect" class="info-fileselect" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" /><input type="submit" name="info-fileadd" class="info-fileadd" value="上传" /></form>
					</div>
					<div class="info-search">
						<input type="text" name="file-search-text" placeholder="查询所需车辆是否添加" class="file-search-text"><input type="submit" name="file-search-action" value="" class="file-search-action">
						<p class="file-search-result"><span>该地址未添加</span><a href="#"></a></p>
					</div>
				</div>
			</li>
		</ul>
		<form class="info-bottom" method="post" action="" enctype="multipart/form-data">
			<input type="button" name="" value="上一步" class="cancel" disabled="disabled">
			<input type="button" name="" value="下一步" class="sure">
		</form>
	</div>
	<!-- 计算两地时间距离 -->
	<div class="info1">
		<h1 class="info-tit">计算两地时间距离</h1>
		<ul class="info-panel">
			<li class="info-panel-wrap">
				<h2 class="info-panel-tit">经纬度计算</h2>
				<div class="info-panel-cont">
					<div class="now-action"><span>中心地址经纬度计算进度：</span><span class="now-progress">0%</span><div class="start" id="start-center"></div><div class="stop"></div><div class="restart"></div></div>
					<div class="now-action"><span>服务点地址经纬度计算进度：</span><span class="now-progress">0%</span><div class="start" id="start-service"></div><div class="stop"></div><div class="restart"></div></div>
				</div>
			</li>
			<li class="info-panel-wrap">
				<h2 class="info-panel-tit">计算两地车行时间和距离</h2>
				<div class="info-panel-cont">
					<div class="now-action"><span>两地间隔时间和距离计算进度：</span><span class="now-progress">0%</span><div class="start"></div><div class="stop"></div><div class="restart"></div></div>
				</div>
		   </li>
		</ul>
		<form class="info-bottom" method="post" action="" enctype="multipart/form-data">
			<input type="button" name="" value="上一步" class="cancel1"><input type="button" name="" value="下一步" class="sure1">
		</form>
	</div>
	<!-- 执行算法 -->
	<div class="info2">
		<h1 class="info-tit">执行算法</h1>
		<ul class="info-panel">
			<li class="info-panel-wrap">
				<h2 class="info-panel-tit">遗传算法计算</h2>
				<div class="algo-time"><span>算法已运行：</span><span class="algo-time-dig">1s</span><span class="algo-status">未完成</span><span style="padding-top: 10px;clear: left;padding-bottom: 30px;">方案下载地址:</span><div class="algo-download"></div></div>
			</li>
		</ul>
		<form class="info-bottom" method="post" action="" enctype="multipart/form-data">
			<input type="button" name="" value="上一步" class="cancel2"><input type="button" name="" value="下一步" class="sure2">
		</form>
	</div>
	<script type="text/javascript">
		var map = new BMap.Map("container");    // 创建Map实例
		var point = new BMap.Point(106.55,29.55);
		map.centerAndZoom(point, 13);
		map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放

		// 创建地址解析器实例     
		var myGeo = new BMap.Geocoder();

		//查询中心地址
		function getcenter(){
			var p = new Promise(function(resolve,reject){
				var search_url = "./center.php?action=searchcenter";
				var obj = new XMLHttpRequest();  // XMLHttpRequest对象用于在后台与服务器交换数据          
		        obj.open('GET', search_url, true);
		        obj.onreadystatechange = function() {
		            if (obj.readyState == 4 && obj.status == 200) { // readyState == 4说明请求已完成
		            	//console.log(obj.responseText);
		                resolve(obj.responseText);
		            }
		        };
		        obj.send();
			});
			return p;
		}

		//获取中心经纬度
		function setaddr(data){
			var p = new Promise(function(resolve,reject){
				var obj = {};
				var oStr = "";
				var j = 0;
				var postData = "";
				data = JSON.parse(data);
				//console.log(data);
				var len = data.data.length;
				for(var i=0;i<len;i++){
					var addr = data.data[i].address;
					myGeo.getPoint(addr, function(point){
						if (point) {    
						    obj[data.data[j].address] = {
						    	longitude: point.lng,
						    	latitude: point.lat
						    }
						    j++;
						}
						if(Object.keys(obj).length===len){
							resolve(obj);
						}
					},"重庆市");
				};
			});
			return p;
		}

		//将中心经纬度写入mysql
		function updateaddr(data){
			var p = new Promise(function(resolve,reject){
				//console.log(data);
				var url = "./center.php?action=setcenter";
				//postData = JSON.stringify(data);
				var postData = "";
				var tmp = "";
				(function(){
					for(var key in data){
						tmp = JSON.stringify(data[key]);
						postData += key + '=' + tmp + '&';
					}
				})();
				//console.log(postData);
				var obj = new XMLHttpRequest();  // XMLHttpRequest对象用于在后台与服务器交换数据          
			    obj.open('POST',url,true);
			    obj.setRequestHeader("Content-type","application/x-www-form-urlencoded");
			    obj.onreadystatechange = function() {
			        if (obj.readyState == 4 && obj.status == 200) { // readyState == 4说明请求已完成
			            //console.log(JSON.parse(obj.responseText));
			            //console.log(obj.responseText);
			        }
			    };
			    obj.send(postData);
			})
			return p;
		}

		//查询服务点地址
		function getser(){
			var p = new Promise(function(resolve,reject){
				var search_url = "./service.php?action=searchservice";
				var obj = new XMLHttpRequest();  // XMLHttpRequest对象用于在后台与服务器交换数据          
		        obj.open('GET', search_url, true);
		        obj.onreadystatechange = function() {
		            if (obj.readyState == 4 && obj.status == 200) { // readyState == 4说明请求已完成
		                resolve(obj.responseText);
		            }
		        };
		        obj.send();
			});
			return p;
		}

		//获取服务点经纬度
		function setser(data){
			var p = new Promise(function(resolve,reject){
				var obj = {};
				var oStr = "";
				var j = 0;
				var postData = "";
				data = JSON.parse(data);
				//console.log(data);
				var len = data.data.length;
				//console.log(len);
				for(var i=0;i<data.data.length;i++){
					var addr = data.data[i].address;
					myGeo.getPoint(addr, function(point){
						if (point) {    
						    obj[data.data[j].address] = {
						    	longitude: point.lng,
						    	latitude: point.lat
						    }
						    j++;
						}
						if(Object.keys(obj).length===len){
							resolve(obj);
						}
					},"重庆市");
				};
			});
			return p;
		}


		//将服务点经纬度写入mysql
		function updateser(data){
			var p = new Promise(function(resolve,reject){
				var url = "./service.php?action=setservice";
				//postData = JSON.stringify(data);
				var postData = "";
				var tmp = "";
				(function(){
					for(var key in data){
						tmp = JSON.stringify(data[key]);
						postData += key + '=' + tmp + '&';
					}
				})();
				//console.log(postData);
				var obj = new XMLHttpRequest();  // XMLHttpRequest对象用于在后台与服务器交换数据          
			    obj.open('POST',url,true);
			    obj.setRequestHeader("Content-type","application/x-www-form-urlencoded");
			    obj.onreadystatechange = function() {
			        if (obj.readyState == 4 && obj.status == 200) { // readyState == 4说明请求已完成
			            //console.log(JSON.parse(obj.responseText));
			            //console.log(obj.responseText);
			        }
			    };
			    obj.send(postData);
			})
			return p;
		} 

		var startcenter = document.getElementById("start-center");
		startcenter.onclick = function(){
			getcenter().then(function(data){
				return setaddr(data);
			}).then(function(data){
				updateaddr(data);
			});
		}

		var startservice = document.getElementById("start-service");
		startservice.onclick = function(){
			getser().then(function(data){
				return setser(data);
			}).then(function(data){
				updateser(data);
			});
		}

	</script>
</body>
</html>