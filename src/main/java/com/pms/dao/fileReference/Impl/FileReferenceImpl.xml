<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--映射器文件会被MapperScannerConfigurer自动扫描发现将它们创建成MapperFactoryBean，被MapperFactoryBean自动解析-->
<mapper namespace="com.pms.dao.fileReference.FileReferenceMapper">
    
    <resultMap id="fileReference" type="com.pms.model.filereference.FileReference">
        <result column="file_id" property="fileId"/>
        <result column="team_id" property="teamId"/>
        <result column="project_id" property="projectId"/>
        <result column="user_name" property="user_name"/>
    </resultMap>

    <resultMap id="file" type="com.pms.model.file.FileImpl">
        <id column="file_id" property="fileId"/>
        <result column="file_name" property="fileName"/>
        <result column="url" property="url"/>
        <result column="class" property="fileClass"/>
        <result column="size" property="size"/>
        <result column="create_by" property="createBy"/>
        <result column="create_time" property="createTime"/>
        <result column="del_flag" property="delFlag"/>
        <result column="del_time" property="delTime"/>
        <result column="is_privater" property="isPrivater"/>
    </resultMap>

    <resultMap id="project" type="com.pms.model.project.Project">
        <id column = "id" property="id"/>
        <result column = "project_name" property="projectName"/>
        <result column = "team_name" property="teamName"/>
        <result column = "project_info" property="projectInfo"/>
        <result column = "create_by" property="createBy" />
        <result column = "create_at" property="createAt"/>
        <result column = "del_flag" property="delFlag"/>
    </resultMap>

    <resultMap id="team" type="com.pms.model.team.Team">
        <id column="team_id" property="teamId"/>
        <result column="team_name" property="teamName"/>
        <result column="create_by" property="createBy"/>
        <result column="create_time" property="createTime"/>
        <result column="del_flag" property="delFlag"/>
        <result column="del_time" property="delTime"/>
        <result column="del_remarks" property="delRemarks"/>
    </resultMap>

    <resultMap id="user" type="com.pms.model.user.User">
        <result property="userName" column="user_name"/>
        <result property="password" column="password"/>
        <result property="picture" column="picture"/>
        <result property="peofession" column="peofession"/>
        <result property="createAt" column="create_at"/>
        <result property="delFlag" column="del_flag"/>
        <result property="delRemarks" column="del_remarks"/>
        <result property="stuId" column="stu_id"/>
    </resultMap>

    <resultMap id="teamMember" type="com.pms.model.team.TeamMember">
        <result column="user_name" property="userName"  />
        <result column="team_name" property="teamName" />
        <result column="team_role" property="teamRole"  />
        <result column="team_privelige" property="teamPrivelige"/>
        <result column="join_time" property="joinTime" />
        <result column="join_by" property="joinBy"  />
        <result column="del_flag" property="delFlag" />
        <result column="del_time" property="delTime" />
        <result column="del_by" property="delBy" />
        <result column="del_remarks" property="delRemarks" />
    </resultMap>

    <select id="getFilesByProjectId" parameterType="Integer" resultMap="file">
          SELECT *  FROM file WHERE file_id IN (SELECT file_id FROM file_reference WHERE project_id=#{projectId})
    </select>
    
    <select id="getProjectByFileId" parameterType="java.lang.Integer" resultMap="project">
        SELECT * FROM project WHERE id = (SELECT project_id FROM file_reference WHERE file_id=#{fileId})
    </select>

    <select id="getTeamByFieId" parameterType="java.lang.Integer" resultMap="team">
        SELECT * FROM team WHERE team_name=(SELECT team_name FROM file_reference WHERE file_id=#{fileId})
    </select>

    <select id="getUserByFileId" parameterType="java.lang.Integer" resultMap="user">
        SELECT * FROM user WHERE user_name=(SELECT user_name FROM file_reference WHERE file_id=#{fileId})
    </select>

    <select id="getTeamMembersByFileId" parameterType="java.lang.Integer" resultMap="teamMember">
        SELECT * FROM team_member WHERE team_name=(SELECT team_name FROM team WHERE team_id=(SELECT team_id FROM file_reference
        WHERE file_id=#{fileId}))
    </select>

    <insert id="addFileReferenceToProject">
        INSERT INTO file_reference(file_id,project_id,user_name) VALUES (#{fileId},#{projectId},#{userName})
    </insert>

    <update id="deleteFileReferenceByFileId" parameterType="java.lang.Integer">
        DELETE FROM file_reference WHERE file_id=#{fileId}
    </update>



    


</mapper>